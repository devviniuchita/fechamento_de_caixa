name: ğŸ” Secret Scanning (gitleaks)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Executa todo dia Ã s 02:00 UTC
    - cron: "0 2 * * *"

jobs:
  gitleaks:
    name: ğŸ” Scan for secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Busca histÃ³rico completo

      - name: ğŸ” Run Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --verbose --redact

      - name: ğŸ“Š Upload Gitleaks report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-${{ github.sha }}
          path: gitleaks-report.json
          retention-days: 30

      - name: ğŸš¨ Create issue if secrets found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ SECRETS DETECTED - Immediate Action Required',
              body: `**âš ï¸ SECURITY ALERT: Secrets were found in the repository!**

              ğŸ” **Commit:** ${context.sha}
              ğŸ“… **Date:** ${new Date().toISOString()}
              ğŸŒ¿ **Branch:** ${context.ref}

              **ğŸ“‹ Action Items:**
              1. Download the Gitleaks report from the failed workflow
              2. Identify and rotate any exposed credentials immediately
              3. Remove secrets from the repository
              4. Update this issue when resolved

              **ğŸ“ Workflow:** ${context.payload.html_url}`,
              labels: ['security', 'critical', 'secrets']
            })
