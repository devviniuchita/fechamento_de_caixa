name: ğŸš€ Deploy to Vercel

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: vercel-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ğŸ” Security: This workflow blocks fork PRs from accessing secrets
# Required secrets: VERCEL_TOKEN (Personal access token from Vercel)
# Optional: VERCEL_PROJECT_ID, VERCEL_ORG_ID for faster linking

jobs:
  preview:
    name: ğŸ” Preview Deploy (PR)
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ›¡ï¸ Security check - Block fork PRs
        id: security_check
        run: |
          # Block PRs from forks to prevent secret exposure
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "ğŸš« Fork PR detected: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "ğŸ” Skipping preview deploy for security (no access to secrets)"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=fork" >> "$GITHUB_OUTPUT"
          elif [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âš ï¸ Vercel secrets not configured"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "reason=no_secrets" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… Security check passed"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "reason=none" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ’¬ Comment on fork PR
        if: steps.security_check.outputs.reason == 'fork'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš« **Fork PR - Preview Deploy Blocked**

              This PR originates from a fork and preview deployment has been blocked for security reasons.

              **For maintainers:** Preview deploys are disabled for fork PRs to prevent secret exposure. Test changes locally or create the PR from a branch in the main repository.`
            })

      - name: âš™ï¸ Setup Node.js
        if: steps.security_check.outputs.skip == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Vercel CLI
        if: steps.security_check.outputs.skip == 'false'
        run: npm i -g vercel@latest

      - name: ğŸš€ Deploy Preview to Vercel
        id: deploy
        if: steps.security_check.outputs.skip == 'false'
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Link project (non-interactive, secure)
          vercel link --yes --project "fechamento-de-caixa" --token "$VERCEL_TOKEN" 2>/dev/null
          vercel pull --yes --environment=preview --token "$VERCEL_TOKEN" 2>/dev/null

          # Deploy and capture URL (avoid logging tokens)
          DEPLOY_URL=$(vercel deploy . --yes --token "$VERCEL_TOKEN" 2>/dev/null)
          echo "url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "âœ… Preview deployed successfully"

      - name: ğŸ’¬ Comment preview URL
        if: steps.security_check.outputs.skip == 'false' && steps.deploy.outputs.url != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.number }}"
          DEPLOY_URL="${{ steps.deploy.outputs.url }}"
          BODY="ğŸš€ **Preview Deployment Ready**%0A%0Aâœ… **URL:** $DEPLOY_URL%0AğŸ§© **Commit:** \`${{ github.sha }}\`%0AğŸ”— **Branch:** \`${{ github.head_ref }}\`"
          gh pr comment "$PR_NUMBER" --body "$BODY"

  production:
    name: ğŸŒ Production Deploy
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://fechamento-de-caixa.vercel.app
    permissions:
      contents: read
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate secrets
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ VERCEL_TOKEN not configured in GitHub Secrets"
            echo "ğŸ“ Configure in: Repository Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          echo "âœ… Vercel secrets validated"

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Vercel CLI
        run: npm i -g vercel@latest

      - name: ğŸŒ Deploy to Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          echo "ğŸ”— Linking project..."
          vercel link --yes --project "fechamento-de-caixa" --token "$VERCEL_TOKEN" 2>/dev/null

          echo "ğŸ“¥ Pulling production configuration..."
          vercel pull --yes --environment=production --token "$VERCEL_TOKEN" 2>/dev/null

          echo "ğŸš€ Deploying to production..."
          DEPLOY_URL=$(vercel deploy . --yes --prod --token "$VERCEL_TOKEN" 2>/dev/null)

          echo "âœ… Production deployment successful!"
          echo "ğŸŒ Live URL: $DEPLOY_URL"
